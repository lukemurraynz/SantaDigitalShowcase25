kind: Source
apiVersion: v1
name: wishlist-eh
spec:
  kind: EventHub
  identity:
    kind: MicrosoftEntraWorkloadID
    clientId: 788e6246-70d1-4e56-91d2-e8955b82b2a9
  properties:
    host: santaworkshop-uhgsd-eh.servicebus.windows.net
    eventHubs:
      - wishlist-events
      # Single hub to avoid alias mismatch during subscription
    consumerGroup: $Default
    bootstrapWindow: 1
  middleware:
    - kind: map
      name: wishlist-mapper
      wishlist-events:
        insert:
          - selector: $
            op: Insert
            label: wishlist-events
            id: $.id
            properties:
              id: $.id
              childId: $.childId
              text: $.text
              category: $.category
              budgetEstimate: $.budgetEstimate
              createdAt: $.createdAt
              dedupeKey: $.dedupeKey
              type: $.type
              requestType: $.RequestType
              statusChange: $.StatusChange
      # Removed alias mapping to avoid subscription label mismatch

---
kind: ContinuousQuery
apiVersion: v1
name: wishlist-updates
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    RETURN w.childId AS childId,
           'v1' AS schemaVersion,
           w.text AS text,
           w.category AS category,
           w.budgetEstimate AS budgetEstimate,
           w.createdAt AS createdAt,
           w.type AS type,
           w.dedupeKey AS dedupeKey,
           drasi.changeDateTime(w) AS lastChanged

---
kind: ContinuousQuery
apiVersion: v1
name: wishlist-trending-1h
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  view:
    enabled: true
    retentionPolicy: latest
  query: |
    MATCH (w:`wishlist-events`)
    WHERE drasi.changeDateTime(w) >= datetime() - duration({ minutes: 60 })
      AND w.RequestType = 'gift'
      AND w.text IS NOT NULL
    RETURN w.text AS item,
           count(w) AS frequency

---
kind: ContinuousQuery
apiVersion: v1
name: wishlist-duplicates-global
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    RETURN w.text AS item, count(w) AS itemCount

---
kind: ContinuousQuery
apiVersion: v1
name: wishlist-inactive-children-3d
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    WITH w.childId AS childId, max(drasi.changeDateTime(w)) AS lastEvent
    WHERE lastEvent <= datetime() - duration({ days: 3 })
    RETURN childId, lastEvent

---
kind: ContinuousQuery
apiVersion: v1
name: recommendation-trending-30m
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    WHERE w.type = 'recommendation-update'
    RETURN w.text AS suggestion, count(w) AS freq

---
kind: ContinuousQuery
apiVersion: v1
name: wishlist-duplicates-by-child
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  view:
    enabled: true
    retentionPolicy: latest
  query: |
    MATCH (w1:`wishlist-events`), (w2:`wishlist-events`)
    WHERE w1.text = w2.text 
      AND w1.childId = w2.childId 
      AND w1.id < w2.id
      AND w1.RequestType = 'gift'
      AND w1.text IS NOT NULL
    WITH w1.childId AS childId, w1.text AS item, count(*) + 1 AS duplicateCount
    WHERE duplicateCount > 1
    RETURN childId, item, duplicateCount

---
kind: ContinuousQuery
apiVersion: v1
name: behavior-status-changes
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  view:
    enabled: true
    retentionPolicy: latest
  query: |
    MATCH (w:`wishlist-events`)
    WHERE w.RequestType = 'behavior-update'
      AND w.StatusChange IS NOT NULL
    RETURN w.childId AS childId,
           coalesce(w.StatusChange, 'Unknown') AS newStatus,
           'Unknown' AS previousStatus,
           drasi.changeDateTime(w) AS changedAt

---
kind: Reaction
apiVersion: v1
name: wishlist-debug
spec:
  kind: Debug
  queries:
    wishlist-updates:
    wishlist-trending-1h:
    wishlist-inactive-children-3d:
    wishlist-duplicates-by-child:
    behavior-status-changes:

---
kind: Reaction
apiVersion: v1
name: wishlist-signalr
spec:
  kind: SignalR
  queries:
    wishlist-trending-1h:
    wishlist-inactive-children-3d:
    wishlist-duplicates-by-child:
    behavior-status-changes:

---
kind: Reaction
apiVersion: v1
name: wishlist-sync-cosmos
spec:
  kind: SyncDaprStateStore
  queries:
    wishlist-updates: '{"stateStoreName":"cosmos-state","keyField":"childId"}'
