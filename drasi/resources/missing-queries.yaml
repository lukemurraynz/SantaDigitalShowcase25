
kind: ContinuousQuery
apiVersion: v1
name: wishlist-trending-1h
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  view:
    enabled: true
    retentionPolicy: latest
  query: |
    MATCH (w:`wishlist-events`)
    WHERE drasi.changeDateTime(w) >= datetime() - duration({ minutes: 60 })
    RETURN w.text AS item,
           count(w) AS frequency


---

kind: ContinuousQuery
apiVersion: v1
name: wishlist-duplicates-global
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    RETURN w.text AS item, count(w) AS itemCount


---

kind: ContinuousQuery
apiVersion: v1
name: wishlist-inactive-children-3d
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    WITH w.childId AS childId, max(drasi.changeDateTime(w)) AS lastEvent
    WHERE lastEvent <= datetime() - duration({ days: 3 })
    RETURN childId, lastEvent


---

kind: ContinuousQuery
apiVersion: v1
name: recommendation-trending-30m
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w:`wishlist-events`)
    WHERE w.type = 'recommendation-update'
    RETURN w.text AS suggestion, count(w) AS freq


---

kind: ContinuousQuery
apiVersion: v1
name: wishlist-duplicates-by-child
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  query: |
    MATCH (w1:`wishlist-events`), (w2:`wishlist-events`)
    WHERE w1.text = w2.text AND w1.childId != w2.childId
    RETURN DISTINCT w1.childId AS childId, w1.text AS item


---

kind: ContinuousQuery
apiVersion: v1
name: behavior-status-changes
spec:
  mode: query
  queryLanguage: Cypher
  sources:
    subscriptions:
      - id: wishlist-eh
        nodes:
          - sourceLabel: wishlist-events
  view:
    enabled: true
    retentionPolicy: latest
  query: |
    MATCH (w:`wishlist-events`)
    WHERE w.requestType = 'behavior-update'
    RETURN w.childId AS childId,
           coalesce(w.statusChange, 'Unknown') AS newStatus,
           'Unknown' AS previousStatus,
           drasi.changeDateTime(w) AS changedAt


