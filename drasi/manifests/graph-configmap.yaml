apiVersion: v1
kind: ConfigMap
metadata:
  name: drasi-graph
  namespace: drasi
data:
  graph.yaml: |
    # Embedded from drasi/graph.yaml (cloud-ready)
    version: v1
    nodes:
      - id: wishlist-source
        type: source
        spec:
          kind: eventhub
          fullyQualifiedNamespaceEnv: EVENTHUB_FQDN
          hubName: wishlist-events
          consumerGroup: $Default
          auth:
            kind: managedIdentity
      - id: profile-source
        type: source
        spec:
          kind: cosmos-changefeed
          connectionStringEnv: COSMOS_CONNECTION_STRING
          database: ${COSMOS_DATABASE}
          container: profiles
      - id: recommendation-source
        type: source
        spec:
          kind: eventhub
          fullyQualifiedNamespaceEnv: EVENTHUB_FQDN
          hubName: wishlist-events
          consumerGroup: $Default
          auth:
            kind: managedIdentity
          filter:
            property: type
            equals: recommendation-update
      - id: rec-dedupe
        type: processor
        spec:
          kind: dedupe
          # Use composite key to avoid duplicate recommendation set processing
          key: ${childId}+${recommendationSet.recommendationSetId}
      - id: rec-enrich
        type: processor
        spec:
          kind: map
          expression: |
            {
              recommendationSetId: ${recommendationSet.recommendationSetId},
              childId: ${childId},
              itemCount: ${recommendationSet.items.length},
              availabilityMix: ${recommendationSet.items.map(i=>i.availability).filter(a=>a).join('|')}
            }
      - id: debounce
        type: processor
        spec:
          kind: debounce
          windowSeconds: 5
          key: childId
      - id: dedupe
        type: processor
        spec:
          kind: dedupe
          key: ${childId}+${hash}
      - id: orchestrator-ingest
        type: sink
        spec:
          kind: http
          method: POST
          url: ${API_BASE_URL}/orchestrator/ingest
          headers:
            X-Agent-Secret: ${AGENT_TRIGGER_SECRET}
            X-Drasi-Origin: "1"
            X-Drasi-Node: "wishlist-pipeline"
          bodyTemplate: |
            {
              "schemaVersion": "v1",
              "type": "wishlist",
              "childId": "${childId}",
              "correlationId": "${_correlationId}",
              "payload": ${json}
            }
      - id: orchestrator-profile
        type: sink
        spec:
          kind: http
          method: POST
          url: ${API_BASE_URL}/orchestrator/ingest
          headers:
            X-Agent-Secret: ${AGENT_TRIGGER_SECRET}
            X-Drasi-Origin: "1"
            X-Drasi-Node: "profile-pipeline"
          bodyTemplate: |
            {
              "schemaVersion": "v1",
              "type": "profile",
              "childId": "${childId}",
              "correlationId": "${_correlationId}"
            }
      - id: orchestrator-recommendation
        type: sink
        spec:
          kind: http
          method: POST
          url: ${API_BASE_URL}/orchestrator/ingest
          headers:
            X-Agent-Secret: ${AGENT_TRIGGER_SECRET}
            X-Drasi-Origin: "1"
            X-Drasi-Node: "recommendation-pipeline"
          bodyTemplate: |
            {
              "schemaVersion": "v1",
              "type": "recommendation",
              "childId": "${childId}",
              "recommendationSetId": "${recommendationSet.recommendationSetId}",
              "itemCount": ${recommendationSet.items.length},
              "correlationId": "${_correlationId}",
              "payload": ${json}
            }
      - id: dlq
        type: sink
        spec:
          kind: cosmos
          connectionStringEnv: COSMOS_CONNECTION_STRING
          database: ${COSMOS_DATABASE}
          container: dlq
    edges:
      - from: wishlist-source
        to: debounce
      - from: debounce
        to: dedupe
      - from: dedupe
        to: orchestrator-ingest
        onError: dlq
      - from: profile-source
        to: orchestrator-profile
      - from: recommendation-source
        to: rec-dedupe
      - from: rec-dedupe
        to: rec-enrich
      - from: rec-enrich
        to: orchestrator-recommendation
        onError: dlq