# Drasi graph (demo) â€“ wishlist/profile updates to job queue
version: v1
nodes:
  - id: wishlist-source
    type: source
    spec:
      kind: eventhub
      auth: managedIdentity
      fullyQualifiedNamespaceEnv: EVENTHUB_FQDN
      hubName: wishlist-events
      consumerGroup: $Default
      # fallbackConnectionStringEnv: EVENTHUB_CONNECTION
  - id: profile-source
    type: source
    spec:
      kind: cosmos-changefeed
      connectionStringEnv: COSMOS_CONNECTION_STRING
      database: ${COSMOS_DATABASE}
      container: profiles
  - id: debounce
    type: processor
    spec:
      kind: debounce
      windowSeconds: 5
      key: childId
  - id: dedupe
    type: processor
    spec:
      kind: dedupe
      key: ${childId}+${hash}
  - id: orchestrator-ingest
    type: sink
    spec:
      kind: http
      method: POST
      url: ${API_BASE_URL}/orchestrator/ingest
      headers:
        X-Agent-Secret: ${AGENT_TRIGGER_SECRET}
        X-Drasi-Origin: "1"
        X-Drasi-Node: "wishlist-pipeline"
      bodyTemplate: |
        {
          "schemaVersion": "v1",
          "type": "wishlist",
          "childId": "${childId}",
          "correlationId": "${_correlationId}",
          "payload": ${json}
        }
  - id: orchestrator-profile
    type: sink
    spec:
      kind: http
      method: POST
      url: ${API_BASE_URL}/orchestrator/ingest
      headers:
        X-Agent-Secret: ${AGENT_TRIGGER_SECRET}
        X-Drasi-Origin: "1"
        X-Drasi-Node: "profile-pipeline"
      bodyTemplate: |
        {
          "schemaVersion": "v1",
          "type": "profile",
          "childId": "${childId}",
          "correlationId": "${_correlationId}"
        }
  - id: dlq
    type: sink
    spec:
      kind: cosmos
      connectionStringEnv: COSMOS_CONNECTION_STRING
      database: ${COSMOS_DATABASE}
      container: dlq
edges:
  - from: wishlist-source
    to: debounce
  - from: debounce
    to: dedupe
  - from: dedupe
    to: orchestrator-ingest
    onError: dlq
  - from: profile-source
    to: orchestrator-profile
